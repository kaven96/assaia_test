# Выбор метрик

Обычно для задач детекции объектов на фото и видео исполльзуют метрику Average Precision и её вариации ([A Review of Video Object Detection: Datasets, Metrics and Methods](https://www.mdpi.com/2076-3417/10/21/7834), [A Survey on Performance Metrics for Object-Detection Algorithms](https://www.researchgate.net/publication/343194514_A_Survey_on_Performance_Metrics_for_Object-Detection_Algorithms)). 

Предполагается, что для вычисления метрики уже есть размеченная выборка, на которой и происходит тренировка и оценка алгоритма.

В данном случае имеются данные не с разметкой кадров, а со временем появления автомобилей в интересующей области и их выходом из неё.

Поэтому в качестве метрики я буду использовать совпадение предсказанных временных интервалов (pred) и ground truth (gt) интервалов. И Precision, Recall на их основе. Будем считать:

* True Positive: длину пересечения участков pred и gt
* False Positive: длину pred участка, которая не пересекается с gt
* False Negative: длину gt участка, которая не пересекается с pred

Также будем использовать метрику F1, которая является комбинацией Precision и Recall, а также Accuracy.

# Подходы к решению задачи

## Первый подход

и кажущийся очевидным --- использовать модели для детекции объектов на фото / видео, определять пересечение bounding box'ов автомобилей с интересующей областью. Плюсы:

1. При достаточно хорошей модели детекции, можно исключить ложные срабатывания при пересечении площадки людьми / пролетом птиц или насекомых перед камерой.

2. Если модель натренирована не только на автомобили, то можно вести в будущем логирование всех перемещений на площадке.

3. Подход простой и понятный, его легко объяснить заказчикам, можно разбить на составляющие (основа --- модель для детекции, остальное --- вспомогательные этапы: предобработка видео, проверка пересечений объектами интересующей зоны)

Минусы:

1. Для работы в real time современных точных моделей для детекции (YOLOv8, detectron2) необходимо иметь достаточно мощный GPU с поддержкой CUDA
2. Более простые модели (Haar Cascade) работают быстро на CPU, но недостаточно точны
3. Не все аэродромные автомобили могут распознаваться предтренированными моделями, поэтому необходимо собирать свой датасет с конкретными аэродромными автомобиями с разных ракурсов.

## Второй подход 

к решению --- вместо решения задачи "по кусочкам", решать её напрямую за счет более сложной модели (CNN), которая будет по видео предсказывать, пересек ли автомобиль границу интересующего участка. Например [Learning Spatiotemporal Features with 3D Convolutional Networks](https://arxiv.org/pdf/1412.0767.pdf)

Это более black box решение, поэтому необходимо использовать датасет как можно большего размера. 

Плюсы:

1. При достаточно большой обучающей выборке и достаточной сложности модели, можно добиться высокого качества работы и отсутствия ложных срабатываний, например, когда перед камерой проезжает автомобиль, который не находится на площадке, но перекрывает часть видимой области
2. Нет необходимости заниматься предварительной обработкой видео, т. к. модель может сама извлекать и правильно взвешивать нужные фичи с видео
3. В конечном итоге модель может быть легче YOLO или Detectron и работать в real time на CPU

Минусы:

1. Нет предобученной модели, необходимо потратить время на ее тренировку
2. Нужно много размеченных видео в разное время суток и в разных погодных условиях

## Выбранный подход

В связи с недостатком времени, используется первый подход. Для детекции автомобилей выбрана модель из библиотеки OpenCV Haar Cascade Classifier и используется предобученная модель для определения автомобилей.

### Гиперпараметры для Haar Cascade

Лучшие гиперпараметры были подобраны поиском по сетке (tune_haar.py). Neighbors: 7, Scale: 1.22.

Лучшие метрики полученные данной моделью:

* Precision: 0.5588235294117647
* Recall: 0.8444444444444444
* Accuracy: 0.5066666666666667
* F1 Score: 0.672566371681416

Данный результат является абсолютно неудовлетворительным. Необходимо использовать другую модель для детекции автомобилей. Либо использовать второй подход к решению задачи.

# Запуск

Для создания файла результатов, и файла с метриками достаточно запустить команду:

```
bash RUN.sh <path_to_video_file> <path_to_polygons.json> <path_to_save_output.json>
```